(window.webpackJsonp=window.webpackJsonp||[]).push([[135],{534:function(t,v,_){"use strict";_.r(v);var r=_(7),s=Object(r.a)({},(function(){var t=this,v=t._self._c;return v("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[v("blockquote",[v("p",[t._v("来源：https://www.toutiao.com/i6677459303055491597")]),t._v(" "),v("p",[t._v("作者：老顾聊技术")])]),t._v(" "),v("h1",{attrs:{id:"前言"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),v("p",[t._v("中大型项目中，一旦遇到数据量比较大，小伙伴应该都知道就应该对数据进行拆分了。有垂直和水平两种。")]),t._v(" "),v("p",[v("strong",[t._v("垂直拆分")]),t._v("比较简单，也就是本来一个数据库，数据量大之后，从业务角度进行拆分多个库。如下图，独立的拆分出订单库 和 用户库。")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://p6-tt.byteimg.com/origin/pgc-image/d46937c167be4cde8560d28346a73a78?from=pc",alt:"你知道怎么分库分表吗？如何做到永不迁移数据和避免热点吗？"}})]),t._v(" "),v("p",[v("strong",[t._v("水平拆分")]),t._v("的概念，是同一个业务数据量大之后，进行水平拆分。")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://p6-tt.byteimg.com/origin/pgc-image/d9c3f43c86854acc8b95bca5a577c243?from=pc",alt:"你知道怎么分库分表吗？如何做到永不迁移数据和避免热点吗？"}})]),t._v(" "),v("p",[t._v("上图中订单数据达到了4000万，我们也知道mysql单表存储量推荐是百万级，如果不进行处理，mysql单表数据太大，会导致性能变慢。使用方案可以参考数据进行水平拆分。把4000万数据拆分4张表或者更多。当然也可以分库，再分表；把压力从数据库层级分开。")]),t._v(" "),v("h1",{attrs:{id:"分库分表方案"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#分库分表方案"}},[t._v("#")]),t._v(" 分库分表方案")]),t._v(" "),v("p",[t._v("分库分表方案中有常用的方案，"),v("strong",[t._v("hash取模和range范围方案")]),t._v("；分库分表方案最主要就是路由算法，"),v("strong",[t._v("把路由的key按照指定的算法进行路由存放")]),t._v("。老顾来介绍一下两个方案的特点。")]),t._v(" "),v("h1",{attrs:{id:"hash取模方案"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#hash取模方案"}},[t._v("#")]),t._v(" "),v("strong",[t._v("hash取模方案")])]),t._v(" "),v("p",[v("img",{attrs:{src:"https://p3-tt.byteimg.com/origin/pgc-image/973bc3f1402d468f8c8433c4c04bcbe2?from=pc",alt:"你知道怎么分库分表吗？如何做到永不迁移数据和避免热点吗？"}})]),t._v(" "),v("p",[t._v("在我们设计系统之前，可以先预估一下大概这几年的订单量，如：4000万。每张表我们可以容纳1000万，也我们可以设计4张表进行存储。")]),t._v(" "),v("blockquote",[v("p",[t._v("那具体如何路由存储的呢？hash的方案就是对指定的路由key（如：id）对分表总数进行取模，上图中，id=12的订单，对4进行取模，也就是会得到0，那此订单会放到0表中。id=13的订单，取模得到为1，就会放到1表中。为什么对4取模，是因为分表总数是4。")])]),t._v(" "),v("ul",[v("li",[v("strong",[t._v("优点：")])])]),t._v(" "),v("p",[t._v("订单数据可以"),v("strong",[t._v("均匀的放到那4张表")]),t._v("中，这样此订单进行操作时，就"),v("strong",[t._v("不会有热点问题")]),t._v("。")]),t._v(" "),v("blockquote",[v("p",[t._v("**热点的含义：**热点的意思就是对订单进行操作集中到1个表中，其他表的操作很少。")]),t._v(" "),v("p",[t._v("订单有个特点就是时间属性，一般用户操作订单数据，都会集中到这段时间产生的订单。如果这段时间产生的订单 都在同一张订单表中，那就会形成热点，那张表的压力会比较大。")])]),t._v(" "),v("ul",[v("li",[v("strong",[t._v("缺点：")])])]),t._v(" "),v("p",[t._v("将来的"),v("strong",[t._v("数据迁移和扩容，会很难")]),t._v("。")]),t._v(" "),v("p",[t._v("如：业务发展很好，订单量很大，超出了4000万的量，那我们就需要增加分表数。如果我们增加4个表")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://p1-tt.byteimg.com/origin/pgc-image/45475c823e514e2791df1454388b4184?from=pc",alt:"你知道怎么分库分表吗？如何做到永不迁移数据和避免热点吗？"}})]),t._v(" "),v("blockquote",[v("p",[t._v("一旦我们增加了分表的总数，取模的基数就会变成8，以前id=12的订单按照此方案就会到4表中查询，但之前的此订单时在0表的，这样就导致了数据查不到。就是因为取模的基数产生了变化。")])]),t._v(" "),v("p",[t._v("遇到这个情况，我们小伙伴想到的方案就是做"),v("strong",[t._v("数据迁移")]),t._v("，"),v("strong",[t._v("把之前的4000万数据，重新做一个hash方案，放到新的规划分表中。也就是我们要做数据迁移。这个是很痛苦的事情")]),t._v("。有些小公司可以接受晚上停机迁移，但大公司是不允许停机做数据迁移的。")]),t._v(" "),v("blockquote",[v("p",[t._v("当然做数据迁移可以结合自己的公司的业务，做一个工具进行，不过也带来了很多工作量，每次扩容都要做数据迁移")])]),t._v(" "),v("p",[t._v("那有没有不需要做数据迁移的方案呢，我们看下面的方案")]),t._v(" "),v("h1",{attrs:{id:"range范围方案"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#range范围方案"}},[t._v("#")]),t._v(" "),v("strong",[t._v("range范围方案")])]),t._v(" "),v("p",[t._v("range方案也就是以范围进行拆分数据。")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://p3-tt.byteimg.com/origin/pgc-image/53e33e687e6c460389ca18ca24537900?from=pc",alt:"你知道怎么分库分表吗？如何做到永不迁移数据和避免热点吗？"}})]),t._v(" "),v("p",[t._v("range方案比较简单，就是把一定范围内的订单，存放到一个表中；"),v("strong",[t._v("如上图id=12放到0表中，id=1300万的放到1表中。设计这个方案时就是前期把表的范围设计好。通过id进行路由存放。")])]),t._v(" "),v("ul",[v("li",[v("strong",[t._v("优点")])])]),t._v(" "),v("p",[t._v("我们小伙伴们想一下，此方案是不是"),v("strong",[t._v("有利于将来的扩容，不需要做数据迁移")]),t._v("。即时再增加4张表，之前的4张表的范围不需要改变，id=12的还是在0表，id=1300万的还是在1表，新增的4张表他们的范围肯定是 大于 4000万之后的范围划分的。")]),t._v(" "),v("ul",[v("li",[v("strong",[t._v("缺点")])])]),t._v(" "),v("p",[v("strong",[t._v("有热点问题")]),t._v("，我们想一下，因为id的值会一直递增变大，那这段时间的订单是不是会一直在某一张表中，"),v("strong",[t._v("如id=1000万 ～ id=2000万之间，这段时间产生的订单是不是都会集中到此张表中，这个就导致1表过热，压力过大，而其他的表没有什么压力")]),t._v("。")]),t._v(" "),v("h1",{attrs:{id:"总结"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结：")]),t._v(" "),v("p",[v("strong",[t._v("hash取模方案")]),t._v("：没有热点问题，但扩容迁移数据痛苦")]),t._v(" "),v("p",[v("strong",[t._v("range方案")]),t._v("：不需要迁移数据，但有热点问题。")])])}),[],!1,null,null,null);v.default=s.exports}}]);