(window.webpackJsonp=window.webpackJsonp||[]).push([[39],{455:function(s,t,a){"use strict";a.r(t);var r=a(7),e=Object(r.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"一、引擎不同锁也不同"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一、引擎不同锁也不同"}},[s._v("#")]),s._v(" 一、引擎不同锁也不同")]),s._v(" "),t("p",[s._v("MyISAM 和 MEMORY 采用 表级锁(table-level locking)")]),s._v(" "),t("p",[s._v("BDB 支持页面锁(page-level locking) 或 表级锁，默认为页面锁")]),s._v(" "),t("blockquote",[t("p",[s._v("MySQL 5.1+ 已不再支持BDB引擎 ，所以不用关注")])]),s._v(" "),t("p",[s._v("InnoDB 支持行级锁(row-level locking) 和 表级锁，默认为行级锁")]),s._v(" "),t("blockquote",[t("p",[s._v("这也是为什么现在业务喜欢选用InnoDB的原因之一")])]),s._v(" "),t("h2",{attrs:{id:"二、按锁定粒度分类"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二、按锁定粒度分类"}},[s._v("#")]),s._v(" 二、按锁定粒度分类")]),s._v(" "),t("p",[t("strong",[s._v("按照对数据的锁定粒度分类，可以分为 ：")])]),s._v(" "),t("div",{staticClass:"language-mermaid extra-class"},[t("pre",{pre:!0,attrs:{class:"language-mermaid"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("graph")]),s._v(" TD\n    A"),t("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[MySQL锁]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" B"),t("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[全局锁]")]),s._v("\n    A "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" C"),t("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[表级锁]")]),s._v("\n    A "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" D"),t("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[行级锁]")]),s._v("\n    \n    B "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" B1"),t("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[Flush Tables With Read Lock]")]),s._v("\n    \n    C "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" C1"),t("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[表锁 Table Lock]")]),s._v("\n    C "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" C2"),t("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[元数据锁 MDL]")]),s._v("\n    C "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" C3"),t("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[意向锁 Intention Lock]")]),s._v("\n    \n    D "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" D1"),t("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[记录锁 Record Lock]")]),s._v("\n    D "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" D2"),t("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[间隙锁 Gap Lock]")]),s._v("\n    D "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" D3"),t("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[临键锁 Next-Key Lock]")]),s._v("\n    D "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" D4"),t("span",{pre:!0,attrs:{class:"token text string"}},[s._v("[插入意向锁 Insert Intention Lock]")]),s._v("\n")])])]),t("h3",{attrs:{id:"_1-全局锁-锁整个数据库实例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-全局锁-锁整个数据库实例"}},[s._v("#")]),s._v(" "),t("strong",[s._v("1. 全局锁")]),s._v(" - 锁整个数据库实例")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 加全局读锁（整个数据库只读）")]),s._v("\nFLUSH "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLES")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WITH")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("READ")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LOCK")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 解锁")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UNLOCK")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLES")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[t("strong",[s._v("特点")]),s._v("：")]),s._v(" "),t("ul",[t("li",[s._v("整个数据库实例只读，所有写操作被阻塞")]),s._v(" "),t("li",[s._v("用于"),t("strong",[s._v("全库逻辑备份")])]),s._v(" "),t("li",[s._v("非常重量级，生产环境慎用")])]),s._v(" "),t("h3",{attrs:{id:"_2-表级锁-锁整张表"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-表级锁-锁整张表"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2. 表级锁")]),s._v(" - 锁整张表")]),s._v(" "),t("h4",{attrs:{id:"_1-表锁-手动锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-表锁-手动锁"}},[s._v("#")]),s._v(" (1) 表锁（手动锁）")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 加表锁")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LOCK")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLES")]),s._v(" users "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("READ")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 读锁，只能读操作")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LOCK")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLES")]),s._v(" users "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WRITE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 写锁 ，只能写操作")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 解锁 UNLOCK TABLES 不需要指定表名和锁类型")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UNLOCK")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLES")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("h4",{attrs:{id:"_2-元数据锁-mdl-自动加锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-元数据锁-mdl-自动加锁"}},[s._v("#")]),s._v(" (2) "),t("strong",[s._v("元数据锁 MDL")]),s._v("（自动加锁）")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("作用")]),s._v("：防止DDL和DML并发冲突")]),s._v(" "),t("li",[t("strong",[s._v("读锁")]),s._v("：增删改查时自动加MDL读锁")]),s._v(" "),t("li",[t("strong",[s._v("写锁")]),s._v("：修改表结构时自动加MDL写锁")])]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 会话1：查询（加MDL读锁）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" users "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 会话2：修改表结构（等待MDL写锁，被阻塞）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALTER")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" users "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ADD")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COLUMN")]),s._v(" age "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INT")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 会话1事务不提交，会话2会一直等待")]),s._v("\n")])])]),t("h4",{attrs:{id:"_3-意向锁-行锁的-预告"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-意向锁-行锁的-预告"}},[s._v("#")]),s._v(" (3) "),t("strong",[s._v("意向锁")]),s._v('（行锁的"预告"）')]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("意向共享锁 IS")]),s._v("：事务打算给某些行加共享锁")]),s._v(" "),t("li",[t("strong",[s._v("意向排他锁 IX")]),s._v("：事务打算给某些行加排他锁")])]),s._v(" "),t("p",[t("strong",[s._v("意向锁的作用")]),s._v("：快速判断表是否被其他事务加锁，避免逐行检查。")]),s._v(" "),t("h3",{attrs:{id:"_3-行级锁-innodb的核心-最常用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-行级锁-innodb的核心-最常用"}},[s._v("#")]),s._v(" 3. "),t("strong",[s._v("行级锁")]),s._v(" - InnoDB的核心（最常用）")]),s._v(" "),t("p",[s._v("行级锁一般也分为共享锁和排他锁")]),s._v(" "),t("h4",{attrs:{id:"_1-记录锁-record-lock"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-记录锁-record-lock"}},[s._v("#")]),s._v(" (1) "),t("strong",[s._v("记录锁 Record Lock")])]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 锁定单行记录（id=1的记录）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" users "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 或")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" users "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LOCK")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("IN")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHARE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("MODE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[t("strong",[s._v("特点")]),s._v("：只锁住索引记录，id必须有索引，否则会锁表。")]),s._v(" "),t("h4",{attrs:{id:"_2-间隙锁-gap-lock"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-间隙锁-gap-lock"}},[s._v("#")]),s._v(" (2) "),t("strong",[s._v("间隙锁 Gap Lock")])]),s._v(" "),t("blockquote",[t("p",[s._v("也可以说是 页级锁，一次锁定相邻的一组记录")])]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 表数据：id=1,3,5,7,9")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 锁定 (5,7) 这个间隙")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" users "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 或")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" users "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("BETWEEN")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("AND")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[s._v("GAP锁的目的，是为了防止同一事务的两次当前读，出现幻读的情况。也为了让其他事务无法在间隙中新增数据。该锁只会在隔离级别是RR或者以上的级别内存在。")]),s._v(" "),t("p",[t("strong",[s._v("特点")]),s._v("：")]),s._v(" "),t("ul",[t("li",[s._v("锁住索引记录之间的间隙，防止幻读")]),s._v(" "),t("li",[s._v("只存在于"),t("strong",[s._v("可重复读隔离级别")])]),s._v(" "),t("li",[s._v("读已提交级别没有间隙锁")])]),s._v(" "),t("h4",{attrs:{id:"_3-临键锁-next-key-lock-记录锁-间隙锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-临键锁-next-key-lock-记录锁-间隙锁"}},[s._v("#")]),s._v(" (3) "),t("strong",[s._v("临键锁 Next-Key Lock")]),s._v(" = 记录锁 + 间隙锁")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 表数据：id=1,3,5,7,9")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 锁定 (3,5] 这个区间（记录5 + 间隙(3,5)）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" users "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[t("strong",[s._v("特点")]),s._v("：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("InnoDB默认行锁算法")])]),s._v(" "),t("li",[s._v("解决幻读问题的关键")])]),s._v(" "),t("h4",{attrs:{id:"_4-插入意向锁-insert-intention-lock"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-插入意向锁-insert-intention-lock"}},[s._v("#")]),s._v(" (4) "),t("strong",[s._v("插入意向锁 Insert Intention Lock")])]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 事务1：锁住间隙")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BEGIN")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" users "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 锁住(10, +∞)")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 事务2：插入时获取插入意向锁")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BEGIN")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" users"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Tom'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 等待插入意向锁")]),s._v("\n")])])]),t("p",[t("strong",[s._v("特点")]),s._v("：插入操作时加的特殊间隙锁，互相不阻塞。")]),s._v(" "),t("h2",{attrs:{id:"三、按锁模式分类"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三、按锁模式分类"}},[s._v("#")]),s._v(" 三、按锁模式分类")]),s._v(" "),t("h3",{attrs:{id:"_1-共享锁-s-lock-读锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-共享锁-s-lock-读锁"}},[s._v("#")]),s._v(" 1. 共享锁 S Lock（读锁）")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 手动加共享锁")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" users "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LOCK")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("IN")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHARE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("MODE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 自动加锁（某些情况）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" users "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 普通查询，快照读，不加锁")]),s._v("\n")])])]),t("p",[t("strong",[s._v("特点")]),s._v("：")]),s._v(" "),t("ul",[t("li",[s._v("允许其他事务加共享锁")]),s._v(" "),t("li",[s._v("不允许其他事务加排他锁")]),s._v(" "),t("li",[s._v("多事务可同时持有共享锁")])]),s._v(" "),t("h3",{attrs:{id:"_2-排他锁-x-lock-写锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-排他锁-x-lock-写锁"}},[s._v("#")]),s._v(" 2. 排他锁 X Lock（写锁）")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 手动加排他锁")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" users "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 自动加锁（增删改）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v(" users "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" name "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Tom'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 自动加排他锁")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DELETE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" users "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 自动加排他锁")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" users"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Jerry'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 自动加排他锁")]),s._v("\n")])])]),t("p",[t("strong",[s._v("特点")]),s._v("：")]),s._v(" "),t("ul",[t("li",[s._v("不允许其他事务加任何锁（加读锁也不行）")]),s._v(" "),t("li",[s._v("当前事务独占资源")])]),s._v(" "),t("h2",{attrs:{id:"四、按加锁方式分类"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#四、按加锁方式分类"}},[s._v("#")]),s._v(" 四、按加锁方式分类")]),s._v(" "),t("h3",{attrs:{id:"_1-悲观锁-默认方式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-悲观锁-默认方式"}},[s._v("#")]),s._v(" 1. "),t("strong",[s._v("悲观锁")]),s._v(" - 默认方式")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 显式悲观锁")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BEGIN")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" products "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 先加锁")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v(" products "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" stock "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" stock "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1001")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMIT")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[t("strong",[s._v("思想")]),s._v('：先加锁，再操作，"假定会发生冲突"')]),s._v(" "),t("h3",{attrs:{id:"_2-乐观锁-应用程序实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-乐观锁-应用程序实现"}},[s._v("#")]),s._v(" 2. "),t("strong",[s._v("乐观锁")]),s._v(" - 应用程序实现")]),s._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 基于版本号的乐观锁")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v(" products \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" stock "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" stock "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" version "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" version "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("AND")]),s._v(" version "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 检查版本")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 或者基于时间戳")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v(" products \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" stock "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" stock "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" update_time "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("NOW")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("AND")]),s._v(" update_time "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2024-01-01 10:00:00'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[t("strong",[s._v("思想")]),s._v('：先操作，冲突时重试，"假定不会冲突"')]),s._v(" "),t("hr")])}),[],!1,null,null,null);t.default=e.exports}}]);