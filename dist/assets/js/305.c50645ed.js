(window.webpackJsonp=window.webpackJsonp||[]).push([[305],{703:function(s,t,a){"use strict";a.r(t);var n=a(7),r=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("虽然你的网站是可以运行了，但想要网站 "),t("code",[s._v("7*24")]),s._v(" 小时高可用不掉线，还远远不够，因为互联网还有一个看不见的手——"),t("strong",[s._v("入侵者")]),s._v("。")]),s._v(" "),t("p",[s._v("如果你买的是云服务器，比如说腾讯云、阿里云这种，一旦你登录了你的服务器，随后没有设置安全组、密钥、用户、IP，或者没有修改密码、默认端口，那么你的服务器就很容易被入侵，一般是被挖矿，或者被操控当做DDOS的攻击者。")]),s._v(" "),t("p",[t("strong",[s._v("可以说，只要你不设置安全组、防火墙，那么你的服务器基本上就没了，别问我为什么知道，因为我的三台服务器就是这么被黑掉的。")])]),s._v(" "),t("p",[s._v("我经历过的三种被黑的情况：")]),s._v(" "),t("ul",[t("li",[s._v("挖矿（目前也是最多的）")]),s._v(" "),t("li",[s._v("DDOS（操控你的服务器攻击其他网站）")]),s._v(" "),t("li",[s._v("勒索（删库）")])]),s._v(" "),t("p",[s._v("本篇文章来介绍一些常见的服务器入侵排查方法。")]),s._v(" "),t("h2",{attrs:{id:"_1、宕机"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、宕机"}},[s._v("#")]),s._v(" 1、宕机")]),s._v(" "),t("p",[s._v("这个是最常见的，一般你的服务器被入侵了，服务器的进程就被杀死了，万一某一天你的网站打不开了，MySQL、Redis都挂了，基本上就是被黑了。")]),s._v(" "),t("h2",{attrs:{id:"_2、日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、日志"}},[s._v("#")]),s._v(" 2、日志")]),s._v(" "),t("h3",{attrs:{id:"_2-1、日志记录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1、日志记录"}},[s._v("#")]),s._v(" 2.1、日志记录")]),s._v(" "),t("p",[s._v("入侵者可能会删除机器的日志信息，可以查看日志信息是否还存在或者是否被清空。")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@VM-8-8-centos ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# du -sh /var/log/*")]),s._v("\n40K     /var/log/anaconda\n36M     /var/log/audit\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("       /var/log/boot.log\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(".0K    /var/log/boot.log-20191106\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(".0K    /var/log/boot.log-20200807\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(".0K    /var/log/boot.log-20200902\n16K     /var/log/boot.log-20201228\n16K     /var/log/boot.log-20210325\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(".8M    /var/log/btmp\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(".9M    /var/log/btmp-20210501\n")])])]),t("p",[t("code",[s._v("/var/log")]),s._v(" 这个目录存在很多操作的日志。")]),s._v(" "),t("p",[s._v("Linux系统常见的日志文件")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("路径1：/var/log/messages：记录 Linux 内核消息及各种应用程序的公共日志信息\n\n路径2：/var/log/cron：记录 crond 计划任务产生的事件信息\n\n路径3：/var/log/dmesg：记录 Linux 操作系统在引导过程中的各种事件信息\n\n路径4：/var/log/maillog：记录进入或发出系统的电子邮件活动\n\n路径5：/var/log/lastlog：记录每个用户最近的登录事件\n\n路径6：/var/log/secure：记录用户认证相关的安全事件信息\n\n路径7：/var/log/wtmp：记录每个用户登录、注销及系统启动和停机事件\n\n路径8：/var/log/btmp：记录失败的、错误的登录尝试及验证事件\n")])])]),t("p",[s._v("所以只要非法者登录，就一定会记录在这里，如果这些日志都被删除了，那么只有一个可能，就是毁尸灭迹。")]),s._v(" "),t("p",[s._v("下面来展开看看一些关键的日志：")]),s._v(" "),t("h3",{attrs:{id:"_2-2、登录失败日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2、登录失败日志"}},[s._v("#")]),s._v(" 2.2、登录失败日志")]),s._v(" "),t("p",[t("code",[s._v("lastlog")]),s._v(" 命令对于的日志是"),t("code",[s._v("/var/log/lastlog")]),s._v("，记录了最近一次的登录用户。")]),s._v(" "),t("p",[s._v("如果一个用户从未登录过，lastlog显示"),t("code",[s._v("**Never logged**")]),s._v("。注意需要以root身份运行该命令。")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@VM-8-8-centos etc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# lastlog")]),s._v("\nUsername         Port     From             Latest\nroot             pts/1    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("119.91")]),s._v(".91.73     Tue May "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(":51:22 +0800 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("\nbin                                        **Never logged in**\ndaemon                                     **Never logged in**\nadm                                        **Never logged in**\nlp                                         **Never logged in**\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sync")]),s._v("                                       **Never logged in**\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("shutdown")]),s._v("                                   **Never logged in**\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("halt")]),s._v("                                       **Never logged in**\n")])])]),t("h3",{attrs:{id:"_2-3、查看机器当前登录的全部用户"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3、查看机器当前登录的全部用户"}},[s._v("#")]),s._v(" 2.3、查看机器当前登录的全部用户")]),s._v(" "),t("p",[t("code",[s._v("who")]),s._v("命令对应日志文件 "),t("code",[s._v("/var/run/utmp")])]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@VM-8-8-centos etc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# who")]),s._v("\nroot     pts/0        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-05-11 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":36 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("119.91")]),s._v(".91.73"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot     pts/1        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-05-11 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(":51 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("119.91")]),s._v(".91.73"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("h3",{attrs:{id:"_2-4、查看机器创建以来登陆过的用户"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-4、查看机器创建以来登陆过的用户"}},[s._v("#")]),s._v(" 2.4、查看机器创建以来登陆过的用户")]),s._v(" "),t("p",[s._v("last 命令对应日志文件"),t("code",[s._v("/var/log/wtmp")])]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@VM-8-8-centos etc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# last")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("reboot")]),s._v("   system boot  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.10")]),s._v(".0-1127.19.1 Wed Mar "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":45 - "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":05 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("47")]),s._v("+23:19"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot     pts/3        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("120.91")]),s._v(".21.11   Tue Mar "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":50 - 00:02  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("03:11"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot     pts/2        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("119.91")]),s._v(".91.73     Mon Mar "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(":34 - crash "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("+02:11"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot     pts/1        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("119.91")]),s._v(".91.73     Mon Mar "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":40 - crash "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("+03:05"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot     pts/2        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("119.91")]),s._v(".91.73     Thu Mar "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":35 - 09:01 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("+17:26"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("p",[t("strong",[s._v("命令输出字段介绍：")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("  第一列：用户名\n  第二列：终端位置。pts/0 (伪终端) 意味着从诸如SSH或telnet的远程连接的用户.tty (teletypewriter) 意味着直接连接到计算机或者本地连接的用户\n  第三列：登录ip或者内核 。如果你看见:0.0 或者什么都没有，这意味着用户通过本地终端连接。除了重启活动，内核版本会显示在状态中。\n  第四列：开始时间\n  第五列：结束时间（still login in 还未退出 down 直到正常关机 crash 直到强制关机）\n  第六列：持续时间\n")])])]),t("h3",{attrs:{id:"_2-5、异常流量"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-5、异常流量"}},[s._v("#")]),s._v(" 2.5、异常流量")]),s._v(" "),t("p",[s._v("如果是挖矿和DDOS，必然会出现大流量，此时可以抓包试试。")]),s._v(" "),t("p",[s._v("可以使用命令 "),t("code",[s._v("tcpdump")]),s._v("抓取网络包查看流量情况，或者使用工具"),t("code",[s._v("iperf")]),s._v("查看流量情况。")]),s._v(" "),t("p",[t("code",[s._v("tcpdump")]),s._v("抓包可以知道目标源IP、端口、数据包是什么。")]),s._v(" "),t("h3",{attrs:{id:"_2-6、抓取入侵者的信息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-6、抓取入侵者的信息"}},[s._v("#")]),s._v(" 2.6、抓取入侵者的信息")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@VM-8-8-centos etc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#  cat /var/log/secure | grep -i "accepted password"')]),s._v("\nDec "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":32:18 VM-8-8-centos sshd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1698")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Accepted password "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" root from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("119.91")]),s._v(".91.72 port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("38620")]),s._v(" ssh2\nDec "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":35:04 VM-8-8-centos sshd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2166")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Accepted password "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" root from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("119.91")]),s._v(".91.72 port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7571")]),s._v(" ssh2\nDec "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":40:59 VM-8-8-centos sshd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2963")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Accepted password "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" root from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("119.91")]),s._v(".91.72 port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("63710")]),s._v(" ssh2\nDec "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":04:12 VM-8-8-centos sshd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6523")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Accepted password "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" root from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("119.91")]),s._v(".91.72 port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("32717")]),s._v(" ssh2\n")])])]),t("p",[s._v("查看这个IP是否可疑，如果不是自己的IP那很可能就是入侵者的IP（一般都是代理的IP）")]),s._v(" "),t("h3",{attrs:{id:"_2-7、top命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-7、top命令"}},[s._v("#")]),s._v(" 2.7、top命令")]),s._v(" "),t("p",[s._v("top命令可以很容易知道服务器的CPU压力，还有进程消耗的CPU资源，如果是挖矿，很容易就被发现了。")]),s._v(" "),t("p",[s._v("但还有一种情况是：入侵者会隐藏挖矿进程，你使用top命令是无法显示这个挖矿进程的，这个就很脑壳痛了。")]),s._v(" "),t("hr"),s._v(" "),t("p",[s._v("以上就是一些简单的排查方法，下一篇文章带你走进真实的服务器被黑排查过程。")])])}),[],!1,null,null,null);t.default=r.exports}}]);