(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{415:function(t,s,a){t.exports=a.p+"assets/img/image-20250821175840111.3830415c.png"},416:function(t,s,a){t.exports=a.p+"assets/img/image-20240516152943309.147f9277.png"},417:function(t,s,a){t.exports=a.p+"assets/img/image-20250825110924971.9a51cb2d.png"},767:function(t,s,a){"use strict";a.r(s);var n=a(7),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("作者我平时不只是写Java，对Python也情有独钟，我尝试使用Python封装opentelemetry，然后提供一个 sdk 给公司团队使用。以下是一些思路和研究，附带到该专栏，对Python不感兴趣的可以略过。")]),t._v(" "),s("p",[t._v("官方对Python接入opentelemetry的说明：")]),t._v(" "),s("p",[t._v("https://opentelemetry.io/docs/languages/python/")]),t._v(" "),s("p",[t._v("前面提到，我已经把 opentelemetry-collector 已经部署起来了，并定义了一个 otlp 协议的 grpc "),s("code",[t._v("receiver")]),t._v("。")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("receivers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("otlp")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("protocols")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("grpc")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("endpoint")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 0.0.0.0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4317")]),t._v("\n")])])]),s("p",[t._v("这里我将直接把数据发送到 "),s("code",[t._v("http://172.16.187.55:4317")])]),t._v(" "),s("h2",{attrs:{id:"指标、链路"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#指标、链路"}},[t._v("#")]),t._v(" 指标、链路")]),t._v(" "),s("p",[t._v("其中指标Metrics、链路Trace 官方都有详细的介绍了。")]),t._v(" "),s("p",[t._v("只需要简单几行代码即可接入成功，然后封装一些指标api，即可打包成 sdk 。")]),t._v(" "),s("p",[t._v("整合Metrics、Trace  的核心代码如下：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# metrics")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" metrics\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" trace\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exporter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("otlp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("proto"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("grpc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("metric_exporter "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" OTLPMetricExporter "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" OTLPMetricExporterGRPC\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exporter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("otlp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("proto"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("grpc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("trace_exporter "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" OTLPSpanExporter "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" OTLPTraceExporterGRPC\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("metrics "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" NoOpMeterProvider\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sdk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("metrics "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sdk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("metrics"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_internal"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("aggregation "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" AggregationTemporality\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sdk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("metrics"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("export "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" PeriodicExportingMetricReader\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sdk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("metrics"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("view "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sdk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("metrics"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("view "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" View\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sdk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("resources "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sdk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("trace "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" TracerProvider"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Tracer\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sdk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("trace"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("export "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" BatchSpanProcessor\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("trace "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" NoOpTracerProvider\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# log")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exporter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("otlp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("proto"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("grpc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_log_exporter "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" OTLPLogExporter "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" OTLPLogExporterGRPC\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" _logs\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sdk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_logs "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" LoggerProvider"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" LoggingHandler\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sdk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_logs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_internal"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("export "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" BatchLogRecordProcessor\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# begin")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#endpoint 是 OTLP exporters grpc 协议的 receivers")]),t._v("\nendpoint "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://172.16.187.55:4317"')]),t._v("\nmetrics_exporter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" OTLPMetricExporterGRPC"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("endpoint"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("endpoint"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nreader "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" PeriodicExportingMetricReader"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("exporter"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("metrics_exporter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" export_interval_millis"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                       export_timeout_millis"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建 Prometheus 导出器")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Start Prometheus client")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# start_http_server(port=8073, addr="localhost")')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# reader = PrometheusMetricReader()")]),t._v("\nconfig "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" get_fcop_config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nmetrics_attributes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    SERVICE_NAMESPACE"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tenant_code"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    SERVICE_NAME"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("app_namespace"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    SERVICE_INSTANCE_ID"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("application_code"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    CLUSTER_TYPE"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cluster_type"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    REGION_CODE"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("region_code"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    HOST_NAME"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Utils"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_hostname"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nmetrics_attributes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("update"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CommonTag"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_common_tag"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nresource "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Resource"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("create"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("metrics_attributes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# metrics")]),t._v("\nmeter_provider "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" MeterProvider"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    resource"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("resource"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" metric_readers"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("reader"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" views"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        change_bucket_view\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nmetrics"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("set_meter_provider"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("meter_provider"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("global")]),t._v(" _meter\n_meter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" metrics"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_meter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"meter-sdk"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# trace")]),t._v("\ntrace_exporter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" OTLPTraceExporterGRPC"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("endpoint"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("endpoint"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" timeout"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                       compression"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("CompressionAlgorithm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("gzip\n                                      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\ntrace_processor "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" BatchSpanProcessor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("span_exporter"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("trace_exporter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                     max_queue_size"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5120")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                     max_export_batch_size"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                     schedule_delay_millis"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                     export_timeout_millis"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntrace_provider "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" TracerProvider"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("resource"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("resource"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntrace_provider"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("add_span_processor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("trace_processor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntrace"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("set_tracer_provider"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("trace_provider"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("global")]),t._v(" _tracer\n_tracer "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" trace"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_tracer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("instrumenting_module_name"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"tracer-sdk"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n")])])]),s("h2",{attrs:{id:"日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#日志"}},[t._v("#")]),t._v(" 日志")]),t._v(" "),s("p",[t._v("日志怎么办？")]),t._v(" "),s("p",[t._v("这里opentelemetry也提供了一种通用的解决方案，就是类似于 filebeat那种，直接扫描指定的日志路径，然后收集日志。这里可以参考我的另外一篇文章。")]),t._v(" "),s("p",[t._v("以上是一种解决方案。")]),t._v(" "),s("p",[t._v("但是如果要通过日志拦截发送的方式，可能会是更好的方案。")]),t._v(" "),s("p",[t._v("后来我看了下"),s("a",{attrs:{href:"https://github.com/open-telemetry/opentelemetry-python",target:"_blank",rel:"noopener noreferrer"}},[t._v("opentelemetry-python"),s("OutboundLink")],1),t._v("的仓库，它的介绍是有关于 Log的试验的：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("Signal")]),t._v(" "),s("th",[t._v("Status")]),t._v(" "),s("th",[t._v("Project")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("Traces")]),t._v(" "),s("td",[t._v("Stable")]),t._v(" "),s("td",[t._v("N/A")])]),t._v(" "),s("tr",[s("td",[t._v("Metrics")]),t._v(" "),s("td",[t._v("Stable")]),t._v(" "),s("td",[t._v("N/A")])]),t._v(" "),s("tr",[s("td",[t._v("Logs")]),t._v(" "),s("td",[t._v("Experimental")]),t._v(" "),s("td",[t._v("N/A")])])])]),t._v(" "),s("p",[t._v("官方也说明了，"),s("strong",[t._v("日志目前还是 开发 中")]),t._v("。")]),t._v(" "),s("blockquote",[s("p",[t._v("2025年8月21日 18:08:56。此时我使用的是  v136.0 版本，注意这里的版本要求")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.34")]),t._v(".0 Requires-Python "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.9")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.34")]),t._v(".1 Requires-Python "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.9")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.35")]),t._v(".0 Requires-Python "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.9")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.36")]),t._v(".0 Requires-Python "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.9")]),t._v("\n")])])]),s("p",[t._v("那这就尴尬，指标、链路都有数据了，没有日志可不行。好消息是最近看到它给了一个例子：")]),t._v(" "),s("blockquote",[s("p",[t._v("https://opentelemetry.io/docs/languages/python/instrumentation/#logs")])]),t._v(" "),s("p",[s("img",{attrs:{src:a(415),alt:""}})]),t._v(" "),s("p",[t._v("接着看，大家猜我发现了什么？")]),t._v(" "),s("p",[t._v("仓库的代码，它在一个"),s("a",{attrs:{href:"https://github.com/open-telemetry/opentelemetry-python/blob/main/docs/examples/logs/example.py",target:"_blank",rel:"noopener noreferrer"}},[t._v("example"),s("OutboundLink")],1),t._v("的使用例子里面，有关于log的使用demo：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(416),alt:""}})]),t._v(" "),s("p",[t._v("安装我本地试了下，竟然成功了。")]),t._v(" "),s("p",[t._v("这样日志直接以otel的协议就发送给 otel-collector 了，这种方案就更简单了。")]),t._v(" "),s("p",[t._v("代码：")]),t._v(" "),s("p",[t._v("otel_sdk_config.py :")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#!/usr/bin/env python")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# -*- coding: utf-8 -*-")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# @Time    :  2025/8/21 18:11")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# @Author  : ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# @File    : otel_sdk_config")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" logging\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" os\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" logging"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("handlers "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" RotatingFileHandler\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" pathlib "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Path\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_logs "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" set_logger_provider\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exporter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("otlp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("proto"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("grpc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_log_exporter "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" OTLPLogExporter\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sdk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_logs "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" LoggerProvider"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" LoggingHandler\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sdk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_logs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("export "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" BatchLogRecordProcessor\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sdk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("resources "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Resource\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" common"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("singleton "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" SingletonMeta\n\nOTEL_EXPORTER_ENDPOINT "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"OTEL_EXPORTER_ENDPOINT"')]),t._v("\n\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setup_custom_logging")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v('"""配置自定义日志系统，输出到控制台和文件"""')]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 获取当前工作目录（项目根目录）")]),t._v("\n    log_dir "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cwd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建根日志记录器")]),t._v("\n    logger "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" logging"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("getLogger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("setLevel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("logging"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DEBUG"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置最低日志级别")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 清除现有的处理器（避免重复添加）")]),t._v("\n    logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("handlers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("clear"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建格式化器")]),t._v("\n    formatter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" logging"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Formatter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%(asctime)s - %(name)s - %(levelname)s - %(message)s'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        datefmt"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%Y-%m-%d %H:%M:%S'")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. 控制台处理器")]),t._v("\n    console_handler "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" logging"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("StreamHandler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    console_handler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("setLevel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("logging"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("INFO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 控制台只显示 INFO 及以上级别")]),t._v("\n    console_handler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("setFormatter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("formatter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. 文件处理器 - 按文件大小轮转")]),t._v("\n    file_handler "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" logging"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("handlers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RotatingFileHandler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        filename"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("log_dir "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"app.log"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        maxBytes"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 10MB")]),t._v("\n        backupCount"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 保留5个备份文件")]),t._v("\n        encoding"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'utf-8'")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    file_handler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("setLevel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("logging"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DEBUG"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 文件记录所有级别")]),t._v("\n    file_handler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("setFormatter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("formatter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加处理器到日志记录器")]),t._v("\n    logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("addHandler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("console_handler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("addHandler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("file_handler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" logger\n\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("OtelConfig")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("metaclass"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("SingletonMeta"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("__init__")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        endpoint "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("getenv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("OTEL_EXPORTER_ENDPOINT"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("or")]),t._v(" os"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("getenv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n            OTEL_EXPORTER_ENDPOINT"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lower"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("or")]),t._v(" os"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("getenv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n            OTEL_EXPORTER_ENDPOINT"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lower"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("replace"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'_'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'.'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("or")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://localhost:4317"')]),t._v("\n\n        exporter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" OTLPLogExporter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("endpoint"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        record_processor "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" BatchLogRecordProcessor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("exporter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        log_provider "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" LoggerProvider"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n            resource"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("Resource"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("create"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"service.name"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"business-demo-web"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"service.instance.id"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"instance-12"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        log_provider"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("add_log_record_processor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("record_processor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        set_logger_provider"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("log_provider"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        handler "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" LoggingHandler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("level"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("logging"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("INFO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" logger_provider"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("log_provider"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 自定义 logger 配置")]),t._v("\n        logger "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" setup_custom_logging"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("addHandler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("handler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        logging"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("info"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('" OTEL config successfully"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n")])])]),s("p",[t._v("otel_logs.py  main 测试类入口：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#!/usr/bin/env python")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# -*- coding: utf-8 -*-")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# @Time    :  2025/8/21 18:03")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# @Author  : ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# @File    : otel_logs")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" os\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" logging\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" threading\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" datetime "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" datetime\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" com"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("opentelemetry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("otel_sdk_config "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" OtelConfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" get_loggers\n\nos"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("environ"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"OTEL_EXPORTER_ENDPOINT"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://172.16.187.55:4317"')]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" __name__ "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__main__'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\n    config "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" OtelConfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"OpenTelemetry"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    extra_attributes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"thread.id"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" threading"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_ident"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"thread.name"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" threading"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("current_thread"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"process.id"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" os"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("getpid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"timestamp"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" datetime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("now"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("isoformat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"custom.field"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"custom_value"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    logger "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" logging"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("getLogger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__name__"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("info"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"测试 otel logger 上报"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("可以看到，日志已经上报成功：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(417),alt:""}})]),t._v(" "),s("p",[t._v("关于 opentelemetry log 模块的使用，仅支持 python 的 "),s("code",[t._v("logging")]),t._v(" 日志库，像其他的日志框架和库如："),s("code",[t._v("loguru")]),t._v("、"),s("code",[t._v("structlog")]),t._v("、"),s("code",[t._v("logbook")]),t._v("  均不支持日志拦截上报。")])])}),[],!1,null,null,null);s.default=e.exports}}]);